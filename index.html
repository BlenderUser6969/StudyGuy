<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Guy - AI Tutor & Cramming Tool</title>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, getDoc, setDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        window.firebaseModules = { 
            initializeApp, getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously, 
            GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile,
            getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, getDoc, setDoc, where,
            getFunctions, httpsCallable
        };
    </script>

    <!-- Tailwind Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; }

        /* Mode Themes */
        .mode-blurt { --primary: #4f46e5; --bg: #eef2ff; --text: #4338ca; }
        .mode-art { --primary: #0ea5e9; --bg: #e0f2fe; --text: #0369a1; }
        .mode-essay { --primary: #e11d48; --bg: #ffe4e6; --text: #be123c; }
        .mode-speech { --primary: #d97706; --bg: #fef3c7; --text: #b45309; }
        .mode-presentation { --primary: #16a34a; --bg: #dcfce7; --text: #15803d; }

        /* Dark Mode Overrides */
        .dark .mode-blurt { --bg: rgba(79, 70, 229, 0.15); --text: #818cf8; }
        .dark .mode-art { --bg: rgba(14, 165, 233, 0.15); --text: #38bdf8; }
        .dark .mode-essay { --bg: rgba(225, 29, 72, 0.15); --text: #fb7185; }
        .dark .mode-speech { --bg: rgba(217, 119, 6, 0.15); --text: #fbbf24; }
        .dark .mode-presentation { --bg: rgba(22, 163, 74, 0.15); --text: #4ade80; }

        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(225, 29, 72, 0); }
            100% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0); }
        }

        .locked-overlay {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(2px);
        }
        .dark .locked-overlay {
            background: rgba(0,0,0,0.7);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-800 dark:text-gray-200 h-screen overflow-hidden flex flex-col transition-colors duration-300">

    <!-- Header -->
    <header class="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 px-6 py-4 flex justify-between items-center shrink-0 z-20 relative shadow-sm">
        <div class="flex items-center gap-3 cursor-pointer group" onclick="app.setView('dashboard')">
            <!-- Logo -->
            <img src="studyguylogo.png" alt="Logo" class="w-10 h-10 object-contain group-hover:scale-105 transition-transform rounded-lg" onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden')">
            <!-- Fallback Icon if logo missing -->
            <div class="hidden bg-gray-900 dark:bg-indigo-600 text-white p-2.5 rounded-xl group-hover:scale-105 transition-transform shadow-md">
                <i data-lucide="graduation-cap" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-900 dark:text-white tracking-tight leading-none">Study Guy</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="plan-badge" class="text-[10px] uppercase font-bold px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400">Free Plan</span>
                    <span id="user-status" class="text-xs text-gray-400 flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-gray-300" id="auth-dot"></span>
                        <span id="username-display">Guest</span>
                    </span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button id="auth-btn" onclick="app.toggleAuthModal()" class="text-sm font-bold bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                Sign In
            </button>
            <button id="upgrade-btn" onclick="app.triggerUpgrade()" class="hidden text-sm font-bold bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-4 py-2 rounded-full hover:shadow-lg transition-all transform hover:scale-105">
                Upgrade to Pro
            </button>
            <button onclick="app.toggleSettings()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full text-gray-500 dark:text-gray-400 transition-colors">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app-container" class="flex-1 overflow-y-auto relative scroll-smooth">
        <div class="flex h-full items-center justify-center text-gray-400">
            <div class="flex flex-col items-center gap-3">
                <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-indigo-500"></i>
                <span class="text-sm font-medium">Loading your study space...</span>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 py-8 shrink-0 mt-auto">
        <div class="max-w-5xl mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-4 text-xs text-gray-500 dark:text-gray-400">
            <div class="flex gap-6">
                <button onclick="app.setView('terms')" class="hover:text-gray-900 dark:hover:text-white transition-colors">Terms of Service</button>
                <button onclick="app.setView('privacy')" class="hover:text-gray-900 dark:hover:text-white transition-colors">Privacy Policy</button>
                <button onclick="app.setView('refund')" class="hover:text-gray-900 dark:hover:text-white transition-colors">Refund Policy</button>
            </div>
            <div class="flex items-center gap-4">
                <span>&copy; 2025 Study Guy</span>
                <span class="w-1 h-1 bg-gray-300 dark:bg-gray-700 rounded-full"></span>
                <a href="mailto:logan@aplamon.com" class="hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">logan@aplamon.com</a>
            </div>
        </div>
    </footer>

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-black/50 dark:bg-black/70 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden border border-gray-100 dark:border-gray-800">
            <div class="p-6 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white">Account Access</h2>
                <button onclick="app.toggleAuthModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div id="auth-error-msg" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-3 rounded-lg text-xs text-red-600 dark:text-red-300 break-words"></div>
                <button onclick="app.handleGoogleLogin()" class="w-full flex items-center justify-center gap-3 bg-white dark:bg-gray-800 text-gray-700 dark:text-white border border-gray-300 dark:border-gray-700 py-2.5 rounded-xl font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" /><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" /><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" /></svg>
                    Continue with Google
                </button>
                <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div><span class="flex-shrink-0 mx-4 text-gray-400 text-xs uppercase">Or using email</span><div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div></div>
                <form class="space-y-3" onsubmit="event.preventDefault();">
                    <input type="email" id="auth-email" required placeholder="Email address" class="w-full px-4 py-2.5 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                    <input type="password" id="auth-password" required placeholder="Password" class="w-full px-4 py-2.5 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                    
                    <div id="name-field" class="hidden space-y-3">
                        <input type="text" id="auth-name" placeholder="Your Name (Optional)" class="w-full px-4 py-2.5 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                        
                        <!-- Legal Checkbox -->
                        <label class="flex items-start gap-3 p-2 rounded-lg border border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 cursor-pointer transition-colors group">
                            <div class="relative flex items-center">
                                <input type="checkbox" id="tos-check" class="peer h-4 w-4 cursor-pointer appearance-none rounded border border-gray-300 bg-white checked:border-indigo-600 checked:bg-indigo-600 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 dark:border-gray-600 dark:bg-gray-700 dark:checked:bg-indigo-500">
                                <i data-lucide="check" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 text-white opacity-0 peer-checked:opacity-100 pointer-events-none"></i>
                            </div>
                            <span class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed">
                                I agree to the <button type="button" onclick="app.setView('terms'); app.toggleAuthModal()" class="text-indigo-600 dark:text-indigo-400 hover:underline font-medium">Terms of Service</button>. 
                                By creating an account, I acknowledge the <button type="button" onclick="app.setView('privacy'); app.toggleAuthModal()" class="text-indigo-600 dark:text-indigo-400 hover:underline font-medium">Privacy Policy</button>.
                            </span>
                        </label>
                    </div>

                    <div class="grid grid-cols-2 gap-3 pt-2">
                        <button type="button" onclick="app.handleEmailAuth('login')" id="login-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-xl font-medium transition-colors">Log In</button>
                        <button type="button" onclick="app.showRegisterFields()" id="signup-btn" class="bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-900 dark:text-gray-200 py-2.5 rounded-xl font-medium transition-colors">Sign Up</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 dark:bg-black/70 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden border border-gray-100 dark:border-gray-800">
            <div class="p-6 border-b border-gray-100 dark:border-gray-800">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white">Settings</h2>
            </div>
            <div class="p-6 space-y-5">
                
                <!-- Debug Panel (Hidden by default) -->
                <div id="admin-debug-panel" class="hidden bg-gray-100 dark:bg-gray-800 p-3 rounded-lg text-xs font-mono space-y-1 border border-gray-200 dark:border-gray-700">
                    <p class="font-bold text-gray-500">DEBUG INFO:</p>
                    <p>UID: <span id="debug-uid" class="text-blue-500">...</span></p>
                    <p>Pro: <span id="debug-pro" class="text-red-500">FALSE</span></p>
                    <p>Subs Found: <span id="debug-subs" class="text-gray-500">0</span></p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Your Name</label>
                    <div class="flex gap-2">
                        <input type="text" id="display-name-input" placeholder="Enter your name" 
                               class="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                        <button onclick="app.saveName()" class="bg-indigo-600 text-white px-4 rounded-lg text-sm font-bold hover:bg-indigo-700">Save</button>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Dark Mode</label>
                    <button id="theme-toggle-btn" onclick="app.toggleTheme()" class="w-12 h-6 rounded-full bg-gray-300 dark:bg-indigo-600 relative transition-colors">
                        <div id="theme-toggle-dot" class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform dark:translate-x-6"></div>
                    </button>
                </div>
                
                <!-- Removed API Key Input for Security -->
                <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800">
                    <p class="text-xs text-blue-600 dark:text-blue-400 flex items-center gap-2">
                        <i data-lucide="shield-check" class="w-4 h-4"></i>
                        Secure Cloud Processing Active
                    </p>
                </div>
                
                <div class="pt-4 border-t border-gray-100 dark:border-gray-800 space-y-2">
                    <button onclick="app.resetToFree()" class="block w-full text-left text-xs text-red-400 hover:text-red-500 underline">Reset Account to Free (Dev Only)</button>
                    <button id="sign-out-btn" onclick="app.handleSignOut()" class="block w-full text-left text-xs text-gray-500 hover:text-gray-900 dark:hover:text-white font-bold hidden">Sign Out</button>
                </div>
            </div>
            <div class="p-6 bg-gray-50 dark:bg-gray-800/50 flex justify-end gap-3 border-t border-gray-100 dark:border-gray-800">
                <button onclick="app.toggleSettings()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg font-medium transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Study Guide Modal -->
    <div id="guide-modal" class="fixed inset-0 bg-black/50 dark:bg-black/70 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-2xl h-[80vh] flex flex-col border border-gray-100 dark:border-gray-800 relative overflow-hidden">
            <div class="p-6 border-b border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-100 dark:bg-indigo-900/50 p-1.5 rounded-lg text-indigo-600 dark:text-indigo-400">
                        <i data-lucide="sparkles" class="w-5 h-5"></i>
                    </div>
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white">AI Study Guide</h2>
                </div>
                <button onclick="document.getElementById('guide-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="guide-content" class="flex-1 overflow-y-auto p-8 markdown-body text-sm text-gray-700 dark:text-gray-300 leading-relaxed">
                <!-- Content Injected Here -->
                <div class="flex flex-col items-center justify-center h-full text-gray-400 space-y-4">
                    <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-indigo-500"></i>
                    <p>Generating cheat sheet...</p>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50 shrink-0 flex justify-end gap-2">
                <button onclick="document.execCommand('copy')" class="text-xs font-bold text-gray-500 hover:text-gray-900 dark:hover:text-white px-4 py-2">Copy to Clipboard</button>
                <button onclick="document.getElementById('guide-modal').classList.add('hidden')" class="bg-gray-900 dark:bg-white text-white dark:text-black px-6 py-2 rounded-lg font-bold text-sm">Done</button>
            </div>
        </div>
    </div>

    <!-- Upgrade Modal (REAL STRIPE) -->
    <div id="upgrade-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 backdrop-blur-md">
        <div class="bg-white dark:bg-gray-900 rounded-3xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden border border-indigo-100 dark:border-gray-800 relative">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 to-purple-600"></div>
            <div class="p-8 text-center">
                <div class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="crown" class="w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Upgrade to Study Guy Pro</h2>
                <p class="text-gray-500 dark:text-gray-400 mb-8">Unlock unlimited topics and advanced AI grading modes.</p>
                
                <div class="space-y-3 text-left mb-8 bg-gray-50 dark:bg-gray-800/50 p-6 rounded-2xl">
                    <div class="flex items-center gap-3"><i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i><span class="text-sm font-medium dark:text-gray-300">Unlimited Topics (Free limit: 3)</span></div>
                    <div class="flex items-center gap-3"><i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i><span class="text-sm font-medium dark:text-gray-300">Unlock Essay & Art Grading</span></div>
                    <div class="flex items-center gap-3"><i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i><span class="text-sm font-medium dark:text-gray-300">Unlock Presentation & Speech Modes</span></div>
                </div>

                <div class="flex gap-3">
                    <button onclick="document.getElementById('upgrade-modal').classList.add('hidden')" class="flex-1 py-3 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl font-bold transition-colors">Maybe Later</button>
                    <button onclick="app.startStripeCheckout()" class="flex-1 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-xl font-bold shadow-lg transform transition-transform hover:scale-105 flex items-center justify-center gap-2">
                        <span>Subscribe ($10/mo)</span>
                    </button>
                </div>
                <p class="text-[10px] text-gray-400 mt-4">Secured by Stripe</p>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 dark:bg-white text-white dark:text-gray-900 px-6 py-3 rounded-full shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-2 font-medium pointer-events-none">
        <span id="toast-msg">Message</span>
    </div>

    <script>
        // --- Configuration ---
        const STRIPE_PRICE_ID = "price_1SWjM6IBV0CJ7SHZJPpFHay6";
        const ADMINS = ['logan@aplamon.com'];
        const MODES = { blurt: { id: 'blurt', label: 'Blurting', icon: 'brain-circuit', color: 'text-indigo-600 dark:text-indigo-400', bg: 'bg-indigo-100 dark:bg-indigo-900/30', theme: 'mode-blurt', desc: 'Write or speak everything you know. Graded on recall.', free: true }, art: { id: 'art', label: 'Art & Image', icon: 'palette', color: 'text-sky-600 dark:text-sky-400', bg: 'bg-sky-100 dark:bg-sky-900/30', theme: 'mode-art', desc: 'Upload images. Graded on technique, anatomy, etc.', free: false }, essay: { id: 'essay', label: 'Essay', icon: 'file-text', color: 'text-rose-600 dark:text-rose-400', bg: 'bg-rose-100 dark:bg-rose-900/30', theme: 'mode-essay', desc: 'Upload papers. Graded on grammar and argument.', free: false }, speech: { id: 'speech', label: 'Speech', icon: 'mic', color: 'text-amber-600 dark:text-amber-400', bg: 'bg-amber-100 dark:bg-amber-900/30', theme: 'mode-speech', desc: 'Record audio. Graded on delivery and tone.', free: false }, presentation: { id: 'presentation', label: 'Presentation', icon: 'monitor-play', color: 'text-green-600 dark:text-green-400', bg: 'bg-green-100 dark:bg-green-900/30', theme: 'mode-presentation', desc: 'Upload PDF slides. Graded on design, flow, and content.', free: false } };
        function getLetterGrade(score) { if (score >= 97) return 'A+'; if (score >= 93) return 'A'; if (score >= 90) return 'A-'; if (score >= 87) return 'B+'; if (score >= 83) return 'B'; if (score >= 80) return 'B-'; if (score >= 77) return 'C+'; if (score >= 73) return 'C'; if (score >= 70) return 'C-'; if (score >= 67) return 'D+'; if (score >= 63) return 'D'; if (score >= 60) return 'D-'; return 'F'; }

        class StudyGuyApp {
            constructor() {
                this.state = { topics: [], currentView: 'dashboard', activeTopicId: null, createMode: 'blurt', isRecording: false, historyIndex: 0, tempFile: null, theme: localStorage.getItem('studyguy_theme') || 'light', user: null, isPro: false, customName: localStorage.getItem('studyguy_name') };
                this.container = document.getElementById('app-container');
                this.init();
            }
            async init() { this.applyTheme(this.state.theme); const checkModules = setInterval(async () => { if (window.firebaseModules) { clearInterval(checkModules); await this.initFirebase(); lucide.createIcons(); } }, 100); }
            async initFirebase() {
                try {
                    const { initializeApp, getAuth, onAuthStateChanged, signInAnonymously, getFirestore, getFunctions } = window.firebaseModules;
                    const firebaseConfig = { apiKey: "AIzaSyCYAGvnQW9XdsFoz-AGz63Zl5trW7F2wDk", authDomain: "study-guy.firebaseapp.com", projectId: "study-guy", storageBucket: "study-guy.firebasestorage.app", messagingSenderId: "256814356458", appId: "1:256814356458:web:0df9a4f8d4590cd7338493", measurementId: "G-9YCQ1LE274" };
                    const app = initializeApp(firebaseConfig);
                    this.auth = getAuth(app);
                    this.db = getFirestore(app);
                    this.functions = getFunctions(app, "us-central1"); 
                    this.appId = 'study-guy-live'; 
                    onAuthStateChanged(this.auth, async (user) => { if (user) { this.handleUserLogin(user); } else { await signInAnonymously(this.auth); } });
                } catch (error) { console.error("Firebase Init Error:", error); this.showToast("Offline Mode"); this.render(); }
            }
            async handleUserLogin(user) {
                this.state.user = user;
                if(user.email && ADMINS.includes(user.email)) { const debugPanel = document.getElementById('admin-debug-panel'); if(debugPanel) debugPanel.classList.remove('hidden'); }
                const debugUid = document.getElementById('debug-uid'); if(debugUid) debugUid.innerText = user.uid.substring(0,8) + '...';
                const { doc, getDoc, collection, onSnapshot, query, where } = window.firebaseModules;
                try { const profileSnap = await getDoc(doc(this.db, 'artifacts', this.appId, 'users', user.uid, 'profile', 'info')); if(profileSnap.exists() && profileSnap.data().name) { this.state.customName = profileSnap.data().name; } } catch(e) { console.log("Profile fetch error", e); }
                const statusDot = document.getElementById('auth-dot'); const userLabel = document.getElementById('username-display'); const authBtn = document.getElementById('auth-btn'); const signOutBtn = document.getElementById('sign-out-btn');
                if(statusDot) statusDot.className = "w-2 h-2 rounded-full bg-emerald-500";
                if (user.isAnonymous) { userLabel.innerText = this.state.customName || "Guest"; authBtn.classList.remove('hidden'); signOutBtn.classList.add('hidden'); } 
                else { const name = this.state.customName || user.displayName || user.email?.split('@')[0]; userLabel.innerText = name; authBtn.classList.add('hidden'); signOutBtn.classList.remove('hidden'); }
                try {
                    const subCollection = collection(this.db, 'customers', user.uid, 'subscriptions');
                    onSnapshot(subCollection, (snap) => {
                        const debugSubs = document.getElementById('debug-subs'); if(debugSubs) debugSubs.innerText = snap.size;
                        let hasActive = false; snap.forEach(doc => { const data = doc.data(); if (['active', 'trialing', 'past_due'].includes(data.status)) hasActive = true; });
                        this.state.isPro = hasActive;
                        const debugPro = document.getElementById('debug-pro'); if(debugPro) { debugPro.innerText = hasActive ? "TRUE" : "FALSE"; debugPro.className = hasActive ? "text-green-500" : "text-red-500"; }
                        this.updateHeaderPlan(); this.render();
                    });
                } catch (err) { console.error("Sub Check Failed:", err); }
                this.setupDataListener();
            }
            setupDataListener() {
                if (!this.state.user) return;
                const { collection, onSnapshot, query } = window.firebaseModules;
                const q = query(collection(this.db, 'artifacts', this.appId, 'users', this.state.user.uid, 'topics'));
                onSnapshot(q, (snapshot) => { this.state.topics = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)); this.render(); }, (error) => console.error("Data Fetch Error:", error));
            }
            toggleAuthModal() { const modal = document.getElementById('auth-modal'); const errorMsg = document.getElementById('auth-error-msg'); if(errorMsg) errorMsg.classList.add('hidden'); modal.classList.toggle('hidden'); modal.classList.toggle('flex'); }
            showRegisterFields() { document.getElementById('name-field').classList.remove('hidden'); document.getElementById('login-btn').classList.remove('bg-indigo-600', 'text-white'); document.getElementById('login-btn').classList.add('bg-gray-100', 'text-gray-900', 'dark:bg-gray-800', 'dark:text-gray-200'); document.getElementById('signup-btn').classList.remove('bg-gray-100', 'text-gray-900', 'dark:bg-gray-800', 'dark:text-gray-200'); document.getElementById('signup-btn').classList.add('bg-indigo-600', 'text-white'); document.getElementById('auth-email').focus(); const form = document.querySelector('#auth-modal form'); form.onsubmit = (e) => { e.preventDefault(); this.handleEmailAuth('register'); }; }
            showAuthError(msg, isDomain) { const el = document.getElementById('auth-error-msg'); el.classList.remove('hidden'); if (isDomain) el.innerHTML = `<strong>Domain Error</strong><br>Add this domain to Firebase Console:<br><code>${window.location.hostname}</code>`; else el.innerText = msg; }
            async handleGoogleLogin() { const { GoogleAuthProvider, signInWithPopup } = window.firebaseModules; try { await signInWithPopup(this.auth, new GoogleAuthProvider()); this.toggleAuthModal(); } catch (e) { console.error(e); this.showAuthError(e.message, e.code === 'auth/unauthorized-domain'); } }
            async handleEmailAuth(type) { const { createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } = window.firebaseModules; const email = document.getElementById('auth-email').value; const pass = document.getElementById('auth-password').value; const nameInput = document.getElementById('auth-name').value; const tosCheck = document.getElementById('tos-check'); if (type === 'register') { if (!tosCheck.checked) { this.showAuthError("You must agree to the Terms of Service"); return; } } if(!email || !pass) return this.showAuthError("Enter email and password"); try { if (type === 'register') { const cred = await createUserWithEmailAndPassword(this.auth, email, pass); if(nameInput) { await updateProfile(cred.user, { displayName: nameInput }); this.saveName(nameInput); } } else await signInWithEmailAndPassword(this.auth, email, pass); this.toggleAuthModal(); } catch (e) { console.error(e); this.showAuthError(e.message, e.code === 'auth/unauthorized-domain'); } }
            async handleSignOut() { await window.firebaseModules.signOut(this.auth); this.toggleSettings(); }
            async saveName(nameOverride) { const name = nameOverride || document.getElementById('display-name-input').value; if(!name) return; this.state.customName = name; localStorage.setItem('studyguy_name', name); if(this.state.user) { const { doc, setDoc } = window.firebaseModules; await setDoc(doc(this.db, 'artifacts', this.appId, 'users', this.state.user.uid, 'profile', 'info'), { name: name }, { merge: true }); } document.getElementById('username-display').innerText = name; if(!nameOverride) this.showToast("Name Updated"); }
            triggerUpgrade() { if (this.state.user && this.state.user.isAnonymous) { this.toggleAuthModal(); this.showToast("Please create an account first"); return; } document.getElementById('upgrade-modal').classList.remove('hidden'); document.getElementById('upgrade-modal').classList.add('flex'); }
            async startStripeCheckout() { const { addDoc, collection, onSnapshot } = window.firebaseModules; const btn = document.querySelector('#upgrade-modal button.bg-gradient-to-r'); btn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Redirecting...`; btn.disabled = true; try { const docRef = await addDoc(collection(this.db, 'customers', this.state.user.uid, 'checkout_sessions'), { price: STRIPE_PRICE_ID, success_url: window.location.href, cancel_url: window.location.href, }); onSnapshot(docRef, (snap) => { const { url, error } = snap.data(); if (error) { alert(`An error occurred: ${error.message}`); btn.disabled = false; } if (url) { window.location.assign(url); } }); } catch (e) { console.error(e); alert("Payment Init Failed. Check console."); } }
            async resetToFree() { this.state.isPro = false; const { doc, setDoc } = window.firebaseModules; await setDoc(doc(this.db, 'artifacts', this.appId, 'users', this.state.user.uid, 'profile', 'status'), { isPro: false }, { merge: true }); this.updateHeaderPlan(); this.toggleSettings(); this.render(); this.showToast("Reset to Free"); }
            updateHeaderPlan() { const badge = document.getElementById('plan-badge'); const upgradeBtn = document.getElementById('upgrade-btn'); if (this.state.isPro) { badge.innerText = "PRO"; badge.className = "text-[10px] uppercase font-bold px-1.5 py-0.5 rounded bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-sm"; upgradeBtn.classList.add('hidden'); } else { badge.innerText = "FREE PLAN"; badge.className = "text-[10px] uppercase font-bold px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400"; upgradeBtn.classList.remove('hidden'); } }
            
            async submitAssessment() { const topic = this.state.topics.find(t => t.id === this.state.activeTopicId); const mode = topic.mode; let userContent = ""; if (mode === 'blurt') userContent = document.getElementById('blurt-input').value; else if (mode === 'essay') userContent = document.getElementById('essay-input').value; else if (mode === 'art' || mode === 'presentation') { if(!this.state.tempFile) return this.showToast("Upload a file!"); userContent = "(File Uploaded)"; } else if (mode === 'speech') { if(this.state.audioChunks.length === 0) return this.showToast("Record audio!"); userContent = "(Audio Recorded)"; } if (!userContent) return this.showToast("Input required"); this.setLoading(true); try { const { httpsCallable } = window.firebaseModules; const gradeSubmission = httpsCallable(this.functions, 'aiTutorAgent'); const result = await gradeSubmission({ action: 'grade', topic: topic, userContent: userContent, mode: mode }); const aiResult = result.data; if(!aiResult.letter_grade) aiResult.letter_grade = getLetterGrade(aiResult.score); const newHistoryItem = { id: crypto.randomUUID(), date: new Date().toISOString(), text: userContent, result: aiResult, mode: mode }; const { updateDoc, doc } = window.firebaseModules; await updateDoc(doc(this.db, 'artifacts', this.appId, 'users', this.state.user.uid, 'topics', topic.id), { history: [newHistoryItem, ...topic.history] }); this.setView('result', topic.id); } catch (err) { console.error(err); this.showToast("Error: " + err.message); } finally { this.setLoading(false); } }
            async generateStudyGuide() { const topic = this.state.topics.find(t => t.id === this.state.activeTopicId); const modal = document.getElementById('guide-modal'); const content = document.getElementById('guide-content'); modal.classList.remove('hidden'); modal.classList.add('flex'); content.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-400 space-y-4"><i data-lucide="loader-2" class="w-8 h-8 animate-spin text-indigo-500"></i><p>Generating cheat sheet...</p></div>`; lucide.createIcons(); try { const { httpsCallable } = window.firebaseModules; const generateGuide = httpsCallable(this.functions, 'aiTutorAgent'); const result = await generateGuide({ action: 'guide', topic: topic }); content.innerHTML = marked.parse(result.data.markdown); } catch (err) { content.innerHTML = `<div class="text-center text-red-500"><p>Error generating guide.</p><p class="text-xs mt-2">${err.message}</p></div>`; } }

            toggleTheme() { this.state.theme = this.state.theme === 'light' ? 'dark' : 'light'; localStorage.setItem('studyguy_theme', this.state.theme); this.applyTheme(this.state.theme); }
            applyTheme(theme) { const html = document.documentElement; if (theme === 'dark') html.classList.add('dark'); else html.classList.remove('dark'); }
            toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); document.getElementById('settings-modal').classList.toggle('flex'); }
            saveSettings() { this.toggleSettings(); }
            showToast(msg) { const toast = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; toast.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000); }
            setLoading(isLoading) { const btn = document.getElementById('submit-btn'); if(btn) { btn.disabled = isLoading; document.getElementById('loading-spinner').classList.toggle('hidden', !isLoading); document.getElementById('btn-text').classList.toggle('hidden', isLoading); } }
            
            setView(view, topicId = null) { 
                this.state.currentView = view; 
                this.state.activeTopicId = topicId; 
                this.state.historyIndex = 0; 
                this.state.isRecording = false; 
                this.state.tempFile = null; 
                this.state.audioChunks = []; 
                
                if(this.state.mediaRecorder && this.state.mediaRecorder.state !== 'inactive') {
                    this.state.mediaRecorder.stop();
                }
                this.render(); 
            }
            render() { this.container.innerHTML = ''; if (this.state.currentView === 'dashboard') this.container.innerHTML = this.renderDashboard(); else if (this.state.currentView === 'create') this.container.innerHTML = this.renderCreate(); else if (this.state.currentView === 'session') this.container.innerHTML = this.renderSession(); else if (this.state.currentView === 'result') this.container.innerHTML = this.renderResult(); else if (this.state.currentView === 'privacy') this.container.innerHTML = this.renderPrivacy(); else if (this.state.currentView === 'terms') this.container.innerHTML = this.renderTerms(); else if (this.state.currentView === 'refund') this.container.innerHTML = this.renderRefund(); lucide.createIcons(); }
            
            renderDashboard() { /* ... same dashboard code ... */ 
                const topicsList = this.state.topics.map(topic => {
                    const modeConfig = MODES[topic.mode] || MODES.blurt;
                    const lastResult = topic.history && topic.history.length ? topic.history[0].result : null;
                    const score = lastResult ? lastResult.score : null;
                    const letter = lastResult ? (lastResult.letter_grade || getLetterGrade(score)) : '--';
                    let gradeColor = 'text-gray-300 dark:text-gray-600';
                    if (score !== null) {
                        if (score >= 80) gradeColor = 'text-emerald-600 dark:text-emerald-400';
                        else if (score >= 60) gradeColor = 'text-amber-600 dark:text-amber-400';
                        else gradeColor = 'text-rose-600 dark:text-rose-400';
                    }
                    return `
                    <div onclick="app.setView('session', '${topic.id}')" class="group bg-white dark:bg-gray-900 p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 hover:shadow-lg hover:border-${modeConfig.color.split('-')[1]}-300 transition-all cursor-pointer relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4"><span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold ${modeConfig.bg} ${modeConfig.color}"><i data-lucide="${modeConfig.icon}" class="w-3 h-3"></i> ${modeConfig.label}</span></div>
                        <div class="flex justify-between items-start mb-6 pr-12">
                            <div><h3 class="text-lg font-bold text-gray-900 dark:text-white group-hover:${modeConfig.color} transition-colors line-clamp-1">${topic.title}</h3><p class="text-sm text-gray-500 dark:text-gray-400 line-clamp-2 mt-1 h-10">${topic.description}</p></div>
                        </div>
                        <div class="flex items-end justify-between pt-4 border-t border-gray-100 dark:border-gray-800">
                            <div class="flex flex-col"><span class="text-xs text-gray-400 dark:text-gray-500 uppercase tracking-wider font-bold">Grade</span><div class="flex items-baseline gap-2"><span class="text-3xl font-black ${gradeColor}">${letter}</span><span class="text-sm font-medium text-gray-400">(${score !== null ? score : '-'}%)</span></div></div>
                            <button onclick="app.deleteTopic('${topic.id}', event)" class="z-10 relative p-2 text-gray-300 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg transition-all" title="Delete Topic"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    </div>`;
                }).join('');
                return `<div class="max-w-5xl mx-auto p-6 md:p-10 animate-fade-in"><div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4"><div><h2 class="text-3xl font-extrabold text-gray-900 dark:text-white tracking-tight">Your Dashboard</h2><p class="text-gray-500 dark:text-gray-400 mt-1">Review your topics or create a new one.</p></div>${!this.state.isPro && this.state.topics.length >= 3 ? `<button onclick="app.triggerUpgrade()" class="bg-gray-200 dark:bg-gray-800 text-gray-500 dark:text-gray-400 px-6 py-3 rounded-xl font-semibold flex items-center gap-2 transition-all hover:bg-gray-300 dark:hover:bg-gray-700 cursor-not-allowed opacity-80"><i data-lucide="lock" class="w-5 h-5"></i> Topic Limit Reached</button>` : `<button onclick="app.setView('create')" class="bg-gray-900 dark:bg-indigo-600 hover:bg-black dark:hover:bg-indigo-500 text-white px-6 py-3 rounded-xl shadow-lg font-semibold flex items-center gap-2 transition-all transform hover:scale-105 active:scale-95"><i data-lucide="plus" class="w-5 h-5"></i> New Topic</button>`}</div><div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">${this.state.topics.length ? topicsList : `<div class="col-span-full text-center py-20 bg-white dark:bg-gray-900 rounded-3xl border-2 border-dashed border-gray-200 dark:border-gray-800"><div class="w-20 h-20 bg-gray-50 dark:bg-gray-800 text-gray-400 rounded-full flex items-center justify-center mx-auto mb-6"><i data-lucide="library" class="w-10 h-10"></i></div><h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">It's quiet here...</h3><p class="text-gray-500 dark:text-gray-400 mb-8 max-w-md mx-auto">Create a topic to start studying.</p><button onclick="app.setView('create')" class="text-indigo-600 dark:text-indigo-400 font-bold hover:underline">Create Topic</button></div>`}</div></div>`;
            } 
            renderCreate() { /* ... same create code ... */
                const modes = Object.values(MODES);
                const currentMode = MODES[this.state.createMode];
                return `<div class="max-w-2xl mx-auto p-6 md:p-10 animate-fade-in"><button onclick="app.setView('dashboard')" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white mb-6 flex items-center gap-2 transition-colors font-medium"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button><div class="bg-white dark:bg-gray-900 rounded-3xl shadow-xl border border-gray-100 dark:border-gray-800 overflow-hidden"><div class="p-8 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-gray-800/50"><h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Create New Topic</h2><div class="grid grid-cols-2 md:grid-cols-5 gap-2">${modes.map(m => {const isLocked = !m.free && !this.state.isPro; return `<button type="button" onclick="${isLocked ? 'app.triggerUpgrade()' : `app.state.createMode = '${m.id}'; app.render()`}" class="relative flex flex-col items-center gap-2 p-2 rounded-xl border-2 transition-all ${this.state.createMode === m.id ? `border-${m.color.split('-')[1]}-500 bg-${m.color.split('-')[1]}-50 dark:bg-${m.color.split('-')[1]}-900/20 text-${m.color.split('-')[1]}-700 dark:text-${m.color.split('-')[1]}-300` : 'border-transparent hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-500'} ${isLocked ? 'opacity-60 cursor-not-allowed' : ''}">${isLocked ? `<div class="absolute top-1 right-1 text-gray-400"><i data-lucide="lock" class="w-3 h-3"></i></div>` : ''}<i data-lucide="${m.icon}" class="w-5 h-5"></i><span class="text-[10px] font-bold uppercase tracking-wide">${m.label}</span></button>`}).join('')}</div>${!currentMode.free && !this.state.isPro ? `<div class="mt-4 text-sm text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg flex items-center justify-center gap-2"><i data-lucide="lock" class="w-4 h-4"></i> This mode requires Study Guy Pro.</div>` : `<p class="mt-4 text-sm text-gray-500 dark:text-gray-400 text-center italic">${currentMode.desc}</p>`}</div><form onsubmit="app.addTopic(event)" class="p-8 space-y-6 ${!currentMode.free && !this.state.isPro ? 'opacity-50 pointer-events-none' : ''}"><div><label class="block text-sm font-bold text-gray-900 dark:text-gray-200 mb-2">Title</label><input type="text" name="title" required placeholder="e.g. Biology 101" class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-gray-900 dark:focus:ring-indigo-500 outline-none transition-all"></div><div><label class="block text-sm font-bold text-gray-900 dark:text-gray-200 mb-2">Description</label><textarea name="description" required rows="2" placeholder="Brief summary..." class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-gray-900 dark:focus:ring-indigo-500 outline-none transition-all"></textarea></div><div><label class="block text-sm font-bold text-gray-900 dark:text-gray-200 mb-2">Grading Context</label><textarea name="context" rows="3" placeholder="Specific things the AI should look for..." class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-gray-900 dark:focus:ring-indigo-500 outline-none transition-all"></textarea></div><button type="submit" class="w-full bg-gray-900 dark:bg-indigo-600 hover:bg-black dark:hover:bg-indigo-500 text-white py-4 rounded-xl font-bold shadow-lg transform transition-all active:scale-95">Create Topic</button></form></div></div>`;
            }
            renderSession() { /* ... same session code ... */ 
                const topic = this.state.topics.find(t => t.id === this.state.activeTopicId);
                const modeConfig = MODES[topic.mode];
                let interactionArea = '';
                
                if (topic.mode === 'blurt') interactionArea = `<div class="relative h-full"><textarea id="blurt-input" class="w-full h-full p-6 resize-none outline-none text-lg text-gray-800 dark:text-gray-200 leading-relaxed font-medium placeholder-gray-300 bg-transparent" placeholder="Start typing..."></textarea><button id="blurt-mic-btn" onclick="app.initSpeech()" class="absolute bottom-6 right-6 p-4 rounded-full bg-white dark:bg-gray-800 shadow-lg border border-gray-200 dark:border-gray-700 text-gray-500 hover:text-indigo-600 transition-all transform hover:scale-110"><i data-lucide="mic" class="w-6 h-6"></i><div id="blurt-mic-pulse" class="absolute inset-0 bg-red-400 rounded-full opacity-0 animate-ping hidden"></div></button></div>`;
                else if (topic.mode === 'presentation' || topic.mode === 'art') interactionArea = `<div class="flex flex-col h-full items-center justify-center p-6 bg-gray-50/50 dark:bg-gray-800/50">${this.state.tempFile ? `<div class="relative w-full h-full flex flex-col items-center"><img src="${this.state.tempFile.data}" class="max-h-[50vh] object-contain rounded-lg shadow-md"><button onclick="document.getElementById('file-upload').click()" class="mt-4 text-sm text-blue-600 font-semibold hover:underline">Change File</button>${topic.mode === 'art' ? '<textarea id="art-notes" class="w-full mt-4 p-4 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-900 dark:text-white text-sm outline-none" rows="3" placeholder="Artist notes..."></textarea>' : ''}</div>` : `<label class="cursor-pointer flex flex-col items-center gap-4 p-10 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl hover:bg-blue-50 dark:hover:bg-gray-800 transition-all group"><div class="w-16 h-16 bg-white dark:bg-gray-700 rounded-full shadow-sm flex items-center justify-center text-gray-400 group-hover:text-blue-500"><i data-lucide="upload" class="w-8 h-8"></i></div><span class="text-lg font-bold text-gray-700 dark:text-gray-300">Upload File</span><input type="file" id="file-upload" accept="image/*,.pdf" class="hidden" onchange="app.handleFileSelect(event, 'binary')"></label>`}</div>`;
                else if (topic.mode === 'essay') interactionArea = `<div class="flex flex-col h-full p-6"><div class="flex justify-between items-center mb-4"><span class="text-sm font-bold text-gray-500 uppercase tracking-wide">Essay Content</span><label class="cursor-pointer text-sm bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 px-3 py-1.5 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium flex items-center gap-2"><i data-lucide="upload" class="w-3 h-3"></i> Import .TXT<input type="file" accept=".txt" class="hidden" onchange="app.handleFileSelect(event, 'text')"></label></div><textarea id="essay-input" class="flex-1 w-full p-6 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 resize-none outline-none text-base leading-relaxed font-serif placeholder-gray-300" placeholder="Paste essay...">${this.state.tempFile && this.state.tempFile.type === 'text' ? this.state.tempFile.data : ''}</textarea></div>`;
                else if (topic.mode === 'speech') interactionArea = `<div class="flex flex-col h-full items-center justify-center p-6 relative overflow-hidden"><div class="text-center z-10"><div class="w-32 h-32 rounded-full ${this.state.isRecording ? 'bg-red-50 dark:bg-red-900/20 recording-pulse' : 'bg-amber-50 dark:bg-amber-900/20'} flex items-center justify-center mx-auto mb-8 transition-all duration-500"><i data-lucide="mic" class="w-12 h-12 ${this.state.isRecording ? 'text-red-500' : 'text-amber-500'}"></i></div><h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">${this.state.isRecording ? 'Listening...' : 'Ready to Record'}</h3><button onclick="app.toggleRecording()" class="px-8 py-4 rounded-full font-bold text-lg shadow-lg transition-all transform active:scale-95 flex items-center gap-2 mx-auto ${this.state.isRecording ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-gray-900 dark:bg-white dark:text-black text-white hover:bg-black'}">${this.state.isRecording ? 'Stop Recording' : 'Start Recording'}</button>${this.state.audioChunks.length > 0 && !this.state.isRecording ? `<div class="mt-8 text-green-600 dark:text-green-400 font-medium flex items-center gap-2 justify-center"><i data-lucide="check-circle" class="w-5 h-5"></i> Audio Saved</div>` : ''}</div></div>`;

                return `<div class="h-full flex flex-col max-w-5xl mx-auto w-full bg-white dark:bg-gray-900 shadow-2xl md:my-6 md:rounded-3xl overflow-hidden border border-gray-200 dark:border-gray-800 animate-fade-in"><div class="${modeConfig.bg} px-6 py-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center shrink-0"><div><button onclick="app.setView('dashboard')" class="text-xs font-bold ${modeConfig.color} opacity-70 hover:opacity-100 uppercase tracking-wide mb-1 flex items-center gap-1"><i data-lucide="chevron-left" class="w-3 h-3"></i> Back</button><div class="flex items-center gap-2"><i data-lucide="${modeConfig.icon}" class="w-5 h-5 ${modeConfig.color}"></i><h2 class="text-lg font-bold text-gray-900 dark:text-white">${topic.title}</h2></div></div><div class="flex gap-2"><button onclick="app.generateStudyGuide()" class="text-sm font-bold bg-indigo-100 hover:bg-indigo-200 dark:bg-indigo-900/30 dark:hover:bg-indigo-900/50 text-indigo-600 dark:text-indigo-300 px-4 py-2 rounded-lg transition-colors flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> Study Guide</button><button onclick="app.setView('result', '${topic.id}')" class="text-sm font-bold bg-white/50 hover:bg-white dark:bg-black/20 dark:hover:bg-black/40 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg transition-colors ${topic.history && topic.history.length ? '' : 'hidden'}">History</button></div></div><div class="flex-1 relative ${topic.mode}">${interactionArea}</div><div class="p-5 border-t border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 flex justify-end items-center gap-4 shrink-0 z-10"><button id="submit-btn" onclick="app.submitAssessment()" class="bg-gray-900 dark:bg-indigo-600 hover:bg-black dark:hover:bg-indigo-500 text-white px-8 py-3.5 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 min-w-[160px] justify-center"><span id="btn-text">Grade My Work</span><i id="loading-spinner" data-lucide="loader-2" class="w-5 h-5 animate-spin hidden"></i></button></div></div>`;
            }

            renderResult() {
                const topic = this.state.topics.find(t => t.id === this.state.activeTopicId);
                if (!topic || !topic.history || !topic.history.length) { this.setView('session', topic?.id); return; }
                const attempt = topic.history[this.state.historyIndex];
                const { result } = attempt;
                const modeConfig = MODES[attempt.mode || topic.mode];
                const letterGrade = result.letter_grade || getLetterGrade(result.score);
                let gradeColorClass = 'text-rose-500';
                if(result.score >= 60) gradeColorClass = 'text-amber-500'; if(result.score >= 80) gradeColorClass = 'text-emerald-500'; if(result.score >= 90) gradeColorClass = 'text-indigo-500';
                const hasNext = this.state.historyIndex > 0;
                const hasPrev = this.state.historyIndex < topic.history.length - 1;

                return `<div class="max-w-4xl mx-auto p-4 md:p-8 pb-20 animate-fade-in"><div class="flex items-center justify-between mb-6"><button onclick="app.setView('dashboard')" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white flex items-center gap-2 font-medium"><i data-lucide="arrow-left" class="w-4 h-4"></i> Dashboard</button><div class="flex items-center bg-white dark:bg-gray-800 rounded-full shadow-sm border border-gray-200 dark:border-gray-700 p-1"><button onclick="app.navHistory(1)" ${!hasPrev ? 'disabled' : ''} class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-30 transition-colors"><i data-lucide="chevron-left" class="w-4 h-4 text-gray-600 dark:text-gray-300"></i></button><span class="text-xs font-bold px-3 text-gray-500 dark:text-gray-400 min-w-[140px] text-center">${new Date(attempt.date).toLocaleDateString()} <span class="opacity-50">|</span> ${new Date(attempt.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span><button onclick="app.navHistory(-1)" ${!hasNext ? 'disabled' : ''} class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-30 transition-colors"><i data-lucide="chevron-right" class="w-4 h-4 text-gray-600 dark:text-gray-300"></i></button></div></div><div class="bg-white dark:bg-gray-900 rounded-3xl shadow-xl border border-gray-100 dark:border-gray-800 overflow-hidden mb-8"><div class="bg-gray-900 dark:bg-gray-800 p-8 text-white flex flex-col md:flex-row items-center justify-between gap-8 relative overflow-hidden"><div class="absolute top-0 right-0 opacity-10 transform translate-x-10 -translate-y-10"><i data-lucide="${modeConfig.icon}" class="w-64 h-64"></i></div><div class="z-10 text-center md:text-left"><h2 class="text-3xl font-bold mb-2">Assessment Complete</h2><p class="text-gray-400 mb-6 max-w-sm">Results for <span class="text-white font-semibold">${topic.title}</span>.</p></div><div class="flex items-center gap-6 z-10 bg-white/5 p-4 rounded-2xl backdrop-blur-sm border border-white/10"><div class="text-center px-4 border-r border-white/10"><span class="block text-6xl font-black ${gradeColorClass}" style="text-shadow: 0 0 20px rgba(0,0,0,0.5);">${letterGrade}</span></div><div class="text-center px-2"><span class="block text-3xl font-bold text-white">${result.score}</span></div></div></div><div class="p-8 grid md:grid-cols-2 gap-8"><div><h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2"><i data-lucide="thumbs-up" class="w-4 h-4 text-emerald-500"></i> Strengths</h3><div class="markdown-body text-sm text-gray-700 dark:text-gray-300 bg-emerald-50/50 dark:bg-emerald-900/10 p-4 rounded-xl border border-emerald-100 dark:border-emerald-900/20">${marked.parse(result.positive_feedback)}</div></div><div><h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2"><i data-lucide="wrench" class="w-4 h-4 text-rose-500"></i> Improvements</h3><div class="markdown-body text-sm text-gray-700 dark:text-gray-300 bg-rose-50/50 dark:bg-rose-900/10 p-4 rounded-xl border border-rose-100 dark:border-rose-900/20">${marked.parse(result.constructive_feedback)}</div></div></div>${result.missing_concepts && result.missing_concepts.length ? `<div class="border-t border-gray-100 dark:border-gray-800 p-8 bg-gray-50 dark:bg-gray-800/50"><h3 class="text-sm font-bold text-gray-900 dark:text-white uppercase tracking-wider mb-4">Key Concepts to Review</h3><div class="flex flex-wrap gap-2">${result.missing_concepts.map(c => `<span class="px-3 py-1 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 rounded-md text-sm font-medium shadow-sm">${c}</span>`).join('')}</div></div>` : ''}<div class="p-4 bg-gray-100 dark:bg-gray-800 flex justify-center"><button onclick="app.setView('session', '${topic.id}')" class="text-gray-600 dark:text-gray-400 font-bold hover:text-gray-900 dark:hover:text-white flex items-center gap-2 transition-colors"><i data-lucide="rotate-ccw" class="w-4 h-4"></i> Try Again</button></div></div></div>`;
            }

            // Legal Pages Renderers
            renderPrivacy() { return `<div class="max-w-3xl mx-auto p-8 animate-fade-in"><button onclick="app.setView('dashboard')" class="mb-6 text-gray-500 hover:text-gray-900 dark:hover:text-white flex items-center gap-2 font-medium"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Dashboard</button><h1 class="text-3xl font-bold mb-6 dark:text-white tracking-tight">Privacy Policy</h1><div class="markdown-body text-sm text-gray-600 dark:text-gray-300 space-y-4 bg-white dark:bg-gray-900 p-8 rounded-2xl border border-gray-100 dark:border-gray-800"><p><strong>Last updated: 2025/11/24</strong></p><p>Study Guy (we, us, or our) is committed to protecting your privacy. This Privacy Policy explains what personal data we collect, how we use it, and your rights under the EU General Data Protection Regulation (GDPR).</p><p>By using Study Guy, you acknowledge this Privacy Policy.</p><h3>1. Data We Collect</h3><p>We collect the following personal data:</p><ul><li><strong>Account Information:</strong> Name, Email address, Password (securely hashed).</li><li><strong>Automatically Collected Data:</strong> IP address, Device info, Log data.</li><li><strong>Payment Information:</strong> Processed by Stripe. We do not store full credit card numbers.</li><li><strong>User-Generated Content:</strong> Study topics, notes, images, text, etc.</li></ul><h3>2. How We Use Your Data</h3><p>We use your data to create accounts, provide features, record subscriptions, ensure security, and improve performance. We do not sell your data.</p><h3>3. Cookies & Analytics</h3><p>We use essential cookies for login sessions and security. We do not use cookies for advertising.</p><h3>4. Data Retention</h3><p>We retain personal data only as long as necessary to maintain your account and comply with legal obligations.</p><h3>5. Sharing Your Data</h3><p>We share data with trusted providers like Stripe (payments) and hosting providers (Vercel/Google) solely to operate the service.</p><h3>6. Children & Minors</h3><p>Users aged 1317 require parental permission. We do not knowingly collect data from children under 13.</p><h3>7. Your GDPR Rights</h3><p>EU/EEA users have rights to access, rectify, erase, restrict processing, and portability of their data. Contact us to exercise these rights.</p><h3>8. Data Security</h3><p>We use HTTPS, hashed passwords, and secure servers. No system is perfectly secure, but we work to keep data safe.</p><h3>9. Contact Information</h3><p>For privacy questions or deletion requests: <strong>logan@aplamon.com</strong></p></div></div>`; }
            renderTerms() { return `<div class="max-w-3xl mx-auto p-8 animate-fade-in"><button onclick="app.setView('dashboard')" class="mb-6 text-gray-500 hover:text-gray-900 dark:hover:text-white flex items-center gap-2 font-medium"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Dashboard</button><h1 class="text-3xl font-bold mb-6 dark:text-white tracking-tight">Terms of Service</h1><div class="markdown-body text-sm text-gray-600 dark:text-gray-300 space-y-4 bg-white dark:bg-gray-900 p-8 rounded-2xl border border-gray-100 dark:border-gray-800"><p><strong>Last updated: 2025/11/24</strong></p><p>Welcome to Study Guy. By creating an account, you agree to these Terms. If you do not agree, do not use the service.</p><h3>1. Eligibility</h3><p>You must be 13 or older. Under 18s require parental permission.</p><h3>2. Accounts</h3><p>You must provide accurate info. You are responsible for your password security and account activity.</p><h3>3. Subscription & Billing</h3><p>We offer a paid subscription unlocking full tools. Billing is processed by Stripe. You can cancel anytime; access remains until the billing period ends.</p><h3>4. Refunds</h3><p>Refunds are offered only when required by law or for valid reasons at our discretion. See Refund Policy.</p><h3>5. Use of Service</h3><p>Do not break laws, share accounts, or abuse the platform. We may suspend violators.</p><h3>6. AI Tools</h3><p>AI outputs may be inaccurate. You use generated content at your own risk.</p><h3>7. Liability</h3><p>Study Guy is provided "as is". We are not liable for data loss, downtime, or academic outcomes.</p><h3>8. Changes</h3><p>We may update these Terms. Continued use means acceptance.</p><h3>9. Contact</h3><p>Questions? Contact: <strong>logan@aplamon.com</strong></p></div></div>`; }
            renderRefund() { return `<div class="max-w-3xl mx-auto p-8 animate-fade-in"><button onclick="app.setView('dashboard')" class="mb-6 text-gray-500 hover:text-gray-900 dark:hover:text-white flex items-center gap-2 font-medium"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Dashboard</button><h1 class="text-3xl font-bold mb-6 dark:text-white tracking-tight">Refund Policy</h1><div class="markdown-body text-sm text-gray-600 dark:text-gray-300 space-y-4 bg-white dark:bg-gray-900 p-8 rounded-2xl border border-gray-100 dark:border-gray-800"><p><strong>Last updated: 2025/11/24</strong></p><p>Thank you for using Study Guy. This policy explains how refunds are handled.</p><h3>1. General Policy</h3><p>Because digital services are delivered immediately, we generally do not offer automatic refunds. Refunds are granted at our discretion for valid technical reasons.</p><h3>2. EU Consumer Rights</h3><p>EU/EEA users have a 14-day right of withdrawal unless they agreed to immediate access (which waives this right). However, refunds are still possible if the service is defective.</p><h3>3. Renewals</h3><p>Renewals are non-refundable. Cancel before the billing date to avoid charges.</p><h3>4. Billing Errors</h3><p>If you were charged incorrectly, contact us to investigate and receive a full refund if confirmed.</p><h3>5. How to Request</h3><p>Email <strong>logan@aplamon.com</strong> with your account email, charge date, and reason. We respond within 7 business days.</p></div></div>`; }

            // ... [Include other helper methods like navHistory, handleFileSelect, deleteTopic, addTopic from previous version] ...
            addTopic(e) { e.preventDefault(); const f = e.target; const nt = {title: f.title.value, description: f.description.value, context: f.context.value, mode: this.state.createMode, history: [], createdAt: Date.now()}; window.firebaseModules.addDoc(window.firebaseModules.collection(this.db, 'artifacts', this.appId, 'users', this.state.user.uid, 'topics'), nt).then(() => {this.setView('dashboard'); this.showToast('Topic Created')}); }
            deleteTopic(id, e) { e.stopPropagation(); if(confirm('Delete?')) window.firebaseModules.deleteDoc(window.firebaseModules.doc(this.db, 'artifacts', this.appId, 'users', this.state.user.uid, 'topics', id)); }
            navHistory(dir) { const t = this.state.topics.find(x => x.id === this.state.activeTopicId); let n = this.state.historyIndex + dir; if(n < 0) n = 0; if(n >= t.history.length) n = t.history.length - 1; this.state.historyIndex = n; this.render(); }
            handleFileSelect(e, t) { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onload = (evt) => { this.state.tempFile = {data: evt.target.result, type: f.type, name: f.name}; this.render(); }; if(t==='text') r.readAsText(f); else r.readAsDataURL(f); } }
            toggleRecording() { 
                if(this.state.isRecording) { this.state.mediaRecorder.stop(); this.state.isRecording = false; this.render(); } 
                else { navigator.mediaDevices.getUserMedia({audio:true}).then(s => { this.state.mediaRecorder = new MediaRecorder(s); this.state.audioChunks = []; this.state.mediaRecorder.ondataavailable = e => this.state.audioChunks.push(e.data); this.state.mediaRecorder.start(); this.state.isRecording = true; this.render(); }); } 
            }
            initSpeech() { 
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition; if(!SR) return; 
                const r = new SR(); r.continuous = true; r.interimResults = true; 
                const b = document.getElementById('blurt-mic-btn'); const p = document.getElementById('blurt-mic-pulse'); const ta = document.getElementById('blurt-input');
                r.onstart = () => { p.classList.remove('hidden'); b.classList.add('text-red-500', 'border-red-500'); };
                r.onend = () => { p.classList.add('hidden'); b.classList.remove('text-red-500', 'border-red-500'); };
                r.onresult = e => { let f = ''; for(let i=e.resultIndex;i<e.results.length;++i) if(e.results[i].isFinal) f+=e.results[i][0].transcript; if(f) ta.value += (ta.value.endsWith(' ')?'':' ') + f + ' '; };
                r.start(); 
            }
        }
        const app = new StudyGuyApp();
    </script>
</body>
</html>
