<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Guy - AI Tutor & Cramming Tool</title>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, getDoc, setDoc, where, limit, startAt, endAt, getDocs, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        window.firebaseModules = { 
            initializeApp, getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously, 
            GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile,
            getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, getDoc, setDoc, where, limit, startAt, endAt, getDocs, arrayUnion,
            getFunctions, httpsCallable
        };
    </script>

    <!-- Tailwind Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; }
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(225, 29, 72, 0); } 100% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0); } }
        .locked-overlay { background: rgba(255,255,255,0.7); backdrop-filter: blur(2px); }
        .dark .locked-overlay { background: rgba(0,0,0,0.7); }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-800 dark:text-gray-200 h-screen overflow-hidden flex flex-col transition-colors duration-300">

    <!-- Header -->
    <header class="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 px-6 py-4 flex justify-between items-center shrink-0 z-20 relative shadow-sm">
        <div class="flex items-center gap-3 cursor-pointer group" onclick="app.setView('dashboard')">
            <img src="studyguylogo.png" alt="Logo" class="w-10 h-10 object-contain group-hover:scale-105 transition-transform rounded-lg" onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden')">
            <div class="hidden bg-gray-900 dark:bg-indigo-600 text-white p-2.5 rounded-xl group-hover:scale-105 transition-transform shadow-md">
                <i data-lucide="graduation-cap" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-900 dark:text-white tracking-tight leading-none">Study Guy</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="plan-badge" class="text-[10px] uppercase font-bold px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400">Free Plan</span>
                    <span id="user-status" class="text-xs text-gray-400 flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-gray-300" id="auth-dot"></span>
                        <span id="username-display">Guest</span>
                    </span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button id="auth-btn" onclick="app.toggleAuthModal()" class="text-sm font-bold bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                Sign In
            </button>
            <button id="upgrade-btn" onclick="app.triggerUpgrade()" class="hidden text-sm font-bold bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-4 py-2 rounded-full hover:shadow-lg transition-all transform hover:scale-105">
                Upgrade
            </button>
            <button onclick="app.toggleSettings()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full text-gray-500 dark:text-gray-400 transition-colors">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app-container" class="flex-1 overflow-y-auto relative scroll-smooth">
        <div class="flex h-full items-center justify-center text-gray-400">
            <div class="flex flex-col items-center gap-3"><i data-lucide="loader-2" class="w-8 h-8 animate-spin text-indigo-500"></i><span class="text-sm font-medium">Loading...</span></div>
        </div>
    </main>

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-black/50 dark:bg-black/70 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden border border-gray-100 dark:border-gray-800">
            <div class="p-6 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center"><h2 class="text-lg font-bold text-gray-900 dark:text-white">Account Access</h2><button onclick="app.toggleAuthModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="p-6 space-y-4">
                <div id="auth-error-msg" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-3 rounded-lg text-xs text-red-600 dark:text-red-300 break-words"></div>
                <button onclick="app.handleGoogleLogin()" class="w-full flex items-center justify-center gap-3 bg-white dark:bg-gray-800 text-gray-700 dark:text-white border border-gray-300 dark:border-gray-700 py-2.5 rounded-xl font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Continue with Google</button>
                <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div><span class="flex-shrink-0 mx-4 text-gray-400 text-xs uppercase">Or using email</span><div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div></div>
                <form class="space-y-3" onsubmit="event.preventDefault();"><input type="email" id="auth-email" required placeholder="Email" class="w-full px-4 py-2.5 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white"><input type="password" id="auth-password" required placeholder="Password" class="w-full px-4 py-2.5 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                <div id="name-field" class="hidden space-y-3"><input type="text" id="auth-name" placeholder="Your Name" class="w-full px-4 py-2.5 rounded-xl border border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white"><label class="flex items-start gap-3 p-2 cursor-pointer"><input type="checkbox" id="tos-check" class="mt-1 rounded border-gray-300 text-indigo-600"><span class="text-xs text-gray-500 dark:text-gray-400">I agree to Terms.</span></label></div>
                <div class="grid grid-cols-2 gap-3 pt-2"><button onclick="app.handleEmailAuth('login')" id="login-btn" class="bg-indigo-600 text-white py-2.5 rounded-xl font-medium">Log In</button><button onclick="app.showRegisterFields()" id="signup-btn" class="bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white py-2.5 rounded-xl font-medium">Sign Up</button></div></form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 dark:bg-black/70 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden border border-gray-100 dark:border-gray-800">
            <div class="p-6 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center"><h2 class="text-lg font-bold text-gray-900 dark:text-white" id="settings-title">Settings</h2><button onclick="app.toggleSettings()" class="text-gray-400"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="p-6 space-y-5">
                <div><label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Language</label><select id="lang-select" onchange="app.changeLanguage(this.value)" class="w-full px-4 py-2 rounded-lg border dark:bg-gray-800 dark:text-white"><option value="en">English</option><option value="sv">Svenska</option><option value="es">Español</option></select></div>
                <div class="flex justify-between items-center"><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Dark Mode</label><button onclick="app.toggleTheme()" class="w-12 h-6 rounded-full bg-gray-300 dark:bg-indigo-600 relative"><div id="theme-toggle-dot" class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform dark:translate-x-6"></div></button></div>
                <div class="pt-4 border-t border-gray-100 dark:border-gray-800"><button onclick="app.manageSubscription()" class="w-full py-2.5 border rounded-xl text-sm font-bold flex items-center justify-center gap-2 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-800"><i data-lucide="credit-card" class="w-4 h-4"></i> Manage Plan</button></div>
                <div class="pt-2"><button onclick="app.handleSignOut()" class="block w-full text-center text-sm text-red-500 font-bold">Sign Out</button></div>
            </div>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgrade-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 backdrop-blur-md">
        <div class="bg-white dark:bg-gray-900 rounded-3xl shadow-2xl w-full max-w-lg mx-4 p-8 text-center relative border border-indigo-100 dark:border-gray-800">
            <div class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-6"><i data-lucide="crown" class="w-8 h-8"></i></div>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Upgrade to Study Guy Pro</h2>
            <p class="text-gray-500 mb-8">Unlock unlimited tools.</p>
            <div class="flex gap-3"><button onclick="document.getElementById('upgrade-modal').classList.add('hidden')" class="flex-1 py-3 text-gray-500 bg-gray-100 dark:bg-gray-800 rounded-xl font-bold">Later</button><button onclick="app.startStripeCheckout()" class="flex-1 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-bold">Subscribe ($10/mo)</button></div>
            <p class="text-[10px] text-gray-400 mt-4">Secured by Stripe</p>
        </div>
    </div>
    
    <!-- Guide Modal -->
    <div id="guide-modal" class="fixed inset-0 bg-black/50 dark:bg-black/70 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-2xl h-[80vh] flex flex-col border border-gray-100 dark:border-gray-800 relative overflow-hidden">
            <div class="p-6 border-b border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50 flex justify-between items-center shrink-0"><div class="flex items-center gap-2"><div class="bg-indigo-100 dark:bg-indigo-900/50 p-1.5 rounded-lg text-indigo-600 dark:text-indigo-400"><i data-lucide="sparkles" class="w-5 h-5"></i></div><h2 class="text-lg font-bold text-gray-900 dark:text-white">AI Study Guide</h2></div><button onclick="document.getElementById('guide-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div id="guide-content" class="flex-1 overflow-y-auto p-8 markdown-body text-sm text-gray-700 dark:text-gray-300 leading-relaxed"></div>
            <div class="p-4 border-t border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50 shrink-0 flex justify-end gap-2"><button onclick="document.execCommand('copy')" class="text-xs font-bold text-gray-500 hover:text-gray-900 dark:hover:text-white px-4 py-2">Copy</button><button onclick="document.getElementById('guide-modal').classList.add('hidden')" class="bg-gray-900 dark:bg-white text-white dark:text-black px-6 py-2 rounded-lg font-bold text-sm">Done</button></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 dark:bg-white text-white dark:text-gray-900 px-6 py-3 rounded-full shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-2 font-medium pointer-events-none"><span id="toast-msg">Message</span></div>

    <script>
        const STRIPE_PRICE_ID = "price_1SWjM6IBV0CJ7SHZJPpFHay6";
        const ADMINS = ['logan@aplamon.com'];
        const MODES = { blurt: { id: 'blurt', label: 'Blurting', icon: 'brain-circuit', color: 'text-indigo-600 dark:text-indigo-400', bg: 'bg-indigo-100 dark:bg-indigo-900/30', theme: 'mode-blurt', desc: 'Write or speak everything you know. Graded on recall.', free: true }, art: { id: 'art', label: 'Art & Image', icon: 'palette', color: 'text-sky-600 dark:text-sky-400', bg: 'bg-sky-100 dark:bg-sky-900/30', theme: 'mode-art', desc: 'Upload images. Graded on technique, anatomy, etc.', free: false }, essay: { id: 'essay', label: 'Essay', icon: 'file-text', color: 'text-rose-600 dark:text-rose-400', bg: 'bg-rose-100 dark:bg-rose-900/30', theme: 'mode-essay', desc: 'Upload papers. Graded on grammar and argument.', free: false }, speech: { id: 'speech', label: 'Speech', icon: 'mic', color: 'text-amber-600 dark:text-amber-400', bg: 'bg-amber-100 dark:bg-amber-900/30', theme: 'mode-speech', desc: 'Record audio. Graded on delivery and tone.', free: false }, presentation: { id: 'presentation', label: 'Presentation', icon: 'monitor-play', color: 'text-green-600 dark:text-green-400', bg: 'bg-green-100 dark:bg-green-900/30', theme: 'mode-presentation', desc: 'Upload PDF slides. Graded on design, flow, and content.', free: false } };
        function getLetterGrade(score) { if (score >= 97) return 'A+'; if (score >= 93) return 'A'; if (score >= 90) return 'A-'; if (score >= 87) return 'B+'; if (score >= 83) return 'B'; if (score >= 80) return 'B-'; if (score >= 77) return 'C+'; if (score >= 73) return 'C'; if (score >= 70) return 'C-'; if (score >= 67) return 'D+'; if (score >= 63) return 'D'; if (score >= 60) return 'D-'; return 'F'; }
        const TRANSLATIONS = { en: { settings: "Settings" }, sv: { settings: "Inställningar" }, es: { settings: "Ajustes" } };

        class StudyGuyApp {
            constructor() {
                this.state = { topics: [], currentView: 'dashboard', activeTopicId: null, createMode: 'blurt', isRecording: false, historyIndex: 0, tempFile: null, 
                theme: localStorage.getItem('studyguy_theme') || 'light', lang: localStorage.getItem('studyguy_lang') || 'en', 
                user: null, isPro: false, customName: '' };
                this.container = document.getElementById('app-container');
                this.init();
            }
            
            t(key) { return TRANSLATIONS[this.state.lang][key] || key; }
            changeLanguage(lang) { this.state.lang = lang; localStorage.setItem('studyguy_lang', lang); document.getElementById('settings-title').innerText = this.t('settings'); this.render(); }
            async init() { this.applyTheme(this.state.theme); document.getElementById('lang-select').value = this.state.lang; const checkModules = setInterval(async () => { if (window.firebaseModules) { clearInterval(checkModules); await this.initFirebase(); lucide.createIcons(); } }, 100); }
            
            async initFirebase() {
                try {
                    const { initializeApp, getAuth, onAuthStateChanged, signInAnonymously, getFirestore, getFunctions } = window.firebaseModules;
                    const firebaseConfig = { apiKey: "AIzaSyCYAGvnQW9XdsFoz-AGz63Zl5trW7F2wDk", authDomain: "study-guy.firebaseapp.com", projectId: "study-guy", storageBucket: "study-guy.firebasestorage.app", messagingSenderId: "256814356458", appId: "1:256814356458:web:0df9a4f8d4590cd7338493", measurementId: "G-9YCQ1LE274" };
                    const app = initializeApp(firebaseConfig);
                    this.auth = getAuth(app);
                    this.db = getFirestore(app);
                    this.functions = getFunctions(app, "us-central1"); 
                    this.appId = 'study-guy-live'; 
                    onAuthStateChanged(this.auth, async (user) => { if (user) { this.handleUserLogin(user); } else { await signInAnonymously(this.auth); } });
                } catch (error) { console.error("Firebase Error", error); this.render(); }
            }

            async handleUserLogin(user) {
                this.state.user = user;
                const { collection, onSnapshot } = window.firebaseModules;
                
                this.state.customName = user.displayName || 'Guest';
                if(document.getElementById('username-display')) document.getElementById('username-display').innerText = this.state.customName;

                const statusDot = document.getElementById('auth-dot');
                if(statusDot) statusDot.className = "absolute top-2 right-2 w-2 h-2 rounded-full bg-emerald-500";
                if (user.isAnonymous) { document.getElementById('auth-btn').classList.remove('hidden'); } else { document.getElementById('auth-btn').classList.add('hidden'); }
                
                try {
                    const subCollection = collection(this.db, 'customers', user.uid, 'subscriptions');
                    onSnapshot(subCollection, (snap) => {
                        let hasActive = false; snap.forEach(doc => { const data = doc.data(); if (['active', 'trialing', 'past_due'].includes(data.status)) hasActive = true; });
                        this.state.isPro = hasActive;
                        this.updateHeaderPlan();
                    });
                } catch(e) {}
                this.setupDataListener();
            }
            
            updateHeaderPlan() {
                const planBadge = document.getElementById('plan-badge');
                const upgradeBtn = document.getElementById('upgrade-btn');
                
                if (this.state.isPro) {
                    if(planBadge) {
                        planBadge.textContent = "Pro Plan";
                        planBadge.className = "text-[10px] uppercase font-bold px-1.5 py-0.5 rounded bg-indigo-100 text-indigo-600 dark:bg-indigo-900 dark:text-indigo-300 border border-indigo-200 dark:border-indigo-800";
                    }
                    if(upgradeBtn) upgradeBtn.classList.add('hidden');
                } else {
                    if(planBadge) {
                        planBadge.textContent = "Free Plan";
                        planBadge.className = "text-[10px] uppercase font-bold px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400";
                    }
                    if(upgradeBtn) upgradeBtn.classList.remove('hidden');
                }
            }

            setupDataListener() {
                if (!this.state.user) return;
                const { collection, onSnapshot, query } = window.firebaseModules;
                const q = query(collection(this.db, 'artifacts', this.appId, 'users', this.state.user.uid, 'topics'));
                onSnapshot(q, (s) => { this.state.topics = s.docs.map(d => ({ id: d.id, ...d.data() })); if(this.state.currentView === 'dashboard') this.render(); });
            }
            
            // --- AUTH & SUBSCRIPTION METHODS ---

            toggleAuthModal() {
                const el = document.getElementById('auth-modal');
                el.classList.toggle('hidden');
                el.classList.toggle('flex');
            }

            async handleGoogleLogin() {
                const { GoogleAuthProvider, signInWithPopup } = window.firebaseModules;
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(this.auth, provider);
                    this.toggleAuthModal();
                    this.showToast("Signed in with Google");
                } catch (error) {
                    document.getElementById('auth-error-msg').textContent = error.message;
                    document.getElementById('auth-error-msg').classList.remove('hidden');
                }
            }
            
            showRegisterFields() {
                document.getElementById('name-field').classList.remove('hidden');
                document.getElementById('login-btn').classList.add('hidden');
                document.getElementById('signup-btn').textContent = 'Create Account';
                document.getElementById('signup-btn').onclick = () => this.handleEmailAuth('signup');
            }
            
            async handleEmailAuth(mode) {
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                const { createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } = window.firebaseModules;
                
                try {
                    if (mode === 'signup') {
                        const name = document.getElementById('auth-name').value;
                        if (!document.getElementById('tos-check').checked) throw new Error("Accept terms.");
                        const cred = await createUserWithEmailAndPassword(this.auth, email, password);
                        await updateProfile(cred.user, { displayName: name });
                        this.showToast("Account Created!");
                    } else {
                        await signInWithEmailAndPassword(this.auth, email, password);
                        this.showToast("Logged In");
                    }
                    this.toggleAuthModal();
                } catch (error) {
                    document.getElementById('auth-error-msg').textContent = error.message;
                    document.getElementById('auth-error-msg').classList.remove('hidden');
                }
            }

            async handleSignOut() {
                const { signOut } = window.firebaseModules;
                await signOut(this.auth);
                this.state.user = null;
                this.state.topics = [];
                this.toggleSettings();
                this.showToast("Signed Out");
                this.render();
            }

            triggerUpgrade() {
                const modal = document.getElementById('upgrade-modal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            async startStripeCheckout() {
                if (!this.state.user || this.state.user.isAnonymous) {
                     this.showToast("Please sign in first");
                     this.toggleAuthModal();
                     return;
                }
                const { addDoc, collection, onSnapshot } = window.firebaseModules;
                this.showToast("Starting Checkout...");
                
                try {
                    const docRef = await addDoc(collection(this.db, 'customers', this.state.user.uid, 'checkout_sessions'), {
                        price: STRIPE_PRICE_ID,
                        success_url: window.location.href,
                        cancel_url: window.location.href,
                    });
                    
                    onSnapshot(docRef, (snap) => {
                        const { url, error } = snap.data();
                        if (error) {
                            alert(`An error occurred: ${error.message}`);
                        }
                        if (url) {
                            window.location.assign(url);
                        }
                    });
                } catch(e) {
                    console.error("Checkout Error:", e);
                    this.showToast("Checkout failed. Try again.");
                }
            }

            // --- TOPIC MANAGEMENT ---

            async addTopic(e) {
                e.preventDefault();
                const form = e.target;
                const title = form.title.value;
                const desc = form.description.value;
                const context = form.context.value;
                const mode = this.state.createMode;
                
                this.setLoading(true);
                const { addDoc, collection } = window.firebaseModules;
                
                try {
                    await addDoc(collection(this.db, 'artifacts', this.appId, 'users', this.state.user.uid, 'topics'), {
                        title,
                        description: desc,
                        context: context,
                        mode: mode,
                        history: [],
                        createdAt: new Date().toISOString()
                    });
                    this.setView('dashboard');
                    this.showToast("Topic Created!");
                } catch(e) {
                    console.error("Error creating topic:", e);
                    this.showToast("Error creating topic");
                }
                this.setLoading(false);
            }

            async deleteTopic(id, event) {
                if(event) event.stopPropagation();
                if(!confirm("Delete this topic and all history?")) return;
                
                const { doc, deleteDoc } = window.firebaseModules;
                try {
                    await deleteDoc(doc(this.db, 'artifacts', this.appId, 'users', this.state.user.uid, 'topics', id));
                    this.showToast("Topic deleted");
                } catch(e) {
                    console.error("Delete Error", e);
                }
            }
            
            async manageSubscription() {
                if (!this.state.user || this.state.user.isAnonymous) return this.showToast("Log in to manage subscription");
                const { addDoc, collection, onSnapshot } = window.firebaseModules;
                this.showToast("Opening Portal...");
                try {
                    const docRef = await addDoc(collection(this.db, 'customers', this.state.user.uid, 'portal_sessions'), { return_url: window.location.href });
                    onSnapshot(docRef, (snap) => {
                        const { url, error } = snap.data();
                        if (url) window.location.assign(url);
                        if (error) alert(`Error: ${error.message}`);
                    });
                } catch (e) { console.error(e); this.showToast("Failed to open portal"); }
            }

            // --- UI HELPERS ---
            toggleTheme() { this.state.theme = this.state.theme === 'light' ? 'dark' : 'light'; localStorage.setItem('studyguy_theme', this.state.theme); this.applyTheme(this.state.theme); }
            applyTheme(theme) { const html = document.documentElement; if (theme === 'dark') html.classList.add('dark'); else html.classList.remove('dark'); }
            toggleSettings() { const el = document.getElementById('settings-modal'); el.classList.toggle('hidden'); el.classList.toggle('flex'); }
            saveSettings() { this.toggleSettings(); }
            showToast(msg) { const toast = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; toast.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000); }
            setLoading(isLoading) { const btn = document.getElementById('submit-btn'); if(btn) { btn.disabled = isLoading; document.getElementById('loading-spinner').classList.toggle('hidden', !isLoading); document.getElementById('btn-text').classList.toggle('hidden', isLoading); } }
            setView(view, topicId = null) { 
                this.state.currentView = view; 
                this.state.activeTopicId = topicId; 
                this.state.historyIndex = 0; 
                this.state.isRecording = false; 
                this.state.tempFile = null; 
                this.state.audioChunks = []; 
                if(this.state.mediaRecorder && this.state.mediaRecorder.state !== 'inactive') {
                    this.state.mediaRecorder.stop();
                }
                this.render(); 
            }
            
            render() { 
                this.container.innerHTML = ''; 
                if (this.state.currentView === 'dashboard') this.container.innerHTML = this.renderDashboard();
                else if (this.state.currentView === 'create') this.container.innerHTML = this.renderCreate(); 
                else if (this.state.currentView === 'session') this.container.innerHTML = this.renderSession(); 
                else if (this.state.currentView === 'result') this.container.innerHTML = this.renderResult(); 
                else if (this.state.currentView === 'privacy') this.container.innerHTML = this.renderPrivacy(); 
                else if (this.state.currentView === 'terms') this.container.innerHTML = this.renderTerms(); 
                else if (this.state.currentView === 'refund') this.container.innerHTML = this.renderRefund(); 
                lucide.createIcons(); 
            }
            
            renderDashboard() { /* Same dashboard code */ 
                const topicsList = this.state.topics.map(topic => {
                    const modeConfig = MODES[topic.mode] || MODES.blurt;
                    const lastResult = topic.history && topic.history.length ? topic.history[0].result : null;
                    const score = lastResult ? lastResult.score : null;
                    const letter = lastResult ? (lastResult.letter_grade || getLetterGrade(score)) : '--';
                    let gradeColor = 'text-gray-300 dark:text-gray-600';
                    if (score !== null) {
                        if (score >= 80) gradeColor = 'text-emerald-600 dark:text-emerald-400';
                        else if (score >= 60) gradeColor = 'text-amber-600 dark:text-amber-400';
                        else gradeColor = 'text-rose-600 dark:text-rose-400';
                    }
                    return `
                    <div onclick="app.setView('session', '${topic.id}')" class="group bg-white dark:bg-gray-900 p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 hover:shadow-lg hover:border-${modeConfig.color.split('-')[1]}-300 transition-all cursor-pointer relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4"><span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold ${modeConfig.bg} ${modeConfig.color}"><i data-lucide="${modeConfig.icon}" class="w-3 h-3"></i> ${modeConfig.label}</span></div>
                        <div class="flex justify-between items-start mb-6 pr-12">
                            <div><h3 class="text-lg font-bold text-gray-900 dark:text-white group-hover:${modeConfig.color} transition-colors line-clamp-1">${topic.title}</h3><p class="text-sm text-gray-500 dark:text-gray-400 line-clamp-2 mt-1 h-10">${topic.description}</p></div>
                        </div>
                        <div class="flex items-end justify-between pt-4 border-t border-gray-100 dark:border-gray-800">
                            <div class="flex flex-col"><span class="text-xs text-gray-400 dark:text-gray-500 uppercase tracking-wider font-bold">Grade</span><div class="flex items-baseline gap-2"><span class="text-3xl font-black ${gradeColor}">${letter}</span><span class="text-sm font-medium text-gray-400">(${score !== null ? score : '-'}%)</span></div></div>
                            <button onclick="app.deleteTopic('${topic.id}', event)" class="z-10 relative p-2 text-gray-300 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg transition-all" title="Delete Topic"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    </div>`;
                }).join('');
                return `<div class="max-w-5xl mx-auto p-6 md:p-10 animate-fade-in"><div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4"><div><h2 class="text-3xl font-extrabold text-gray-900 dark:text-white tracking-tight">Your Dashboard</h2><p class="text-gray-500 dark:text-gray-400 mt-1">Review your topics or create a new one.</p></div>${!this.state.isPro && this.state.topics.length >= 3 ? `<button onclick="app.triggerUpgrade()" class="bg-gray-200 dark:bg-gray-800 text-gray-500 dark:text-gray-400 px-6 py-3 rounded-xl font-semibold flex items-center gap-2 transition-all hover:bg-gray-300 dark:hover:bg-gray-700 cursor-not-allowed opacity-80"><i data-lucide="lock" class="w-5 h-5"></i> Topic Limit Reached</button>` : `<button onclick="app.setView('create')" class="bg-gray-900 dark:bg-indigo-600 hover:bg-black dark:hover:bg-indigo-500 text-white px-6 py-3 rounded-xl shadow-lg font-semibold flex items-center gap-2 transition-all transform hover:scale-105 active:scale-95"><i data-lucide="plus" class="w-5 h-5"></i> New Topic</button>`}</div><div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">${this.state.topics.length ? topicsList : `<div class="col-span-full text-center py-20 bg-white dark:bg-gray-900 rounded-3xl border-2 border-dashed border-gray-200 dark:border-gray-800"><div class="w-20 h-20 bg-gray-50 dark:bg-gray-800 text-gray-400 rounded-full flex items-center justify-center mx-auto mb-6"><i data-lucide="library" class="w-10 h-10"></i></div><h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">It's quiet here...</h3><p class="text-gray-500 dark:text-gray-400 mb-8 max-w-md mx-auto">Create a topic to start studying.</p><button onclick="app.setView('create')" class="text-indigo-600 dark:text-indigo-400 font-bold hover:underline">Create Topic</button></div>`}</div></div>`;
            } 
            renderCreate() { /* ... same create code ... */
                const modes = Object.values(MODES);
                const currentMode = MODES[this.state.createMode];
                return `<div class="max-w-2xl mx-auto p-6 md:p-10 animate-fade-in"><button onclick="app.setView('dashboard')" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white mb-6 flex items-center gap-2 transition-colors font-medium"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button><div class="bg-white dark:bg-gray-900 rounded-3xl shadow-xl border border-gray-100 dark:border-gray-800 overflow-hidden"><div class="p-8 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-gray-800/50"><h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Create New Topic</h2><div class="grid grid-cols-2 md:grid-cols-5 gap-2">${modes.map(m => {const isLocked = !m.free && !this.state.isPro; return `<button type="button" onclick="${isLocked ? 'app.triggerUpgrade()' : `app.state.createMode = '${m.id}'; app.render()`}" class="relative flex flex-col items-center gap-2 p-2 rounded-xl border-2 transition-all ${this.state.createMode === m.id ? `border-${m.color.split('-')[1]}-500 bg-${m.color.split('-')[1]}-50 dark:bg-${m.color.split('-')[1]}-900/20 text-${m.color.split('-')[1]}-700 dark:text-${m.color.split('-')[1]}-300` : 'border-transparent hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-500'} ${isLocked ? 'opacity-60 cursor-not-allowed' : ''}">${isLocked ? `<div class="absolute top-1 right-1 text-gray-400"><i data-lucide="lock" class="w-3 h-3"></i></div>` : ''}<i data-lucide="${m.icon}" class="w-5 h-5"></i><span class="text-[10px] font-bold uppercase tracking-wide">${m.label}</span></button>`}).join('')}</div>${!currentMode.free && !this.state.isPro ? `<div class="mt-4 text-sm text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg flex items-center justify-center gap-2"><i data-lucide="lock" class="w-4 h-4"></i> This mode requires Study Guy Pro.</div>` : `<p class="mt-4 text-sm text-gray-500 dark:text-gray-400 text-center italic">${currentMode.desc}</p>`}</div><form onsubmit="app.addTopic(event)" class="p-8 space-y-6 ${!currentMode.free && !this.state.isPro ? 'opacity-50 pointer-events-none' : ''}"><div><label class="block text-sm font-bold text-gray-900 dark:text-gray-200 mb-2">Title</label><input type="text" name="title" required placeholder="e.g. Biology 101" class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-gray-900 dark:focus:ring-indigo-500 outline-none transition-all"></div><div><label class="block text-sm font-bold text-gray-900 dark:text-gray-200 mb-2">Description</label><textarea name="description" required rows="2" placeholder="Brief summary..." class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-gray-900 dark:focus:ring-indigo-500 outline-none transition-all"></textarea></div><div><label class="block text-sm font-bold text-gray-900 dark:text-gray-200 mb-2">Grading Context</label><textarea name="context" rows="3" placeholder="Specific things the AI should look for..." class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-gray-900 dark:focus:ring-indigo-500 outline-none transition-all"></textarea></div><button type="submit" class="w-full bg-gray-900 dark:bg-indigo-600 hover:bg-black dark:hover:bg-indigo-500 text-white py-4 rounded-xl font-bold shadow-lg transform transition-all active:scale-95">Create Topic</button></form></div></div>`;
            }
        }
        const app = new StudyGuyApp();
    </script>
</body>
</html>
